# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FluffNwoof - Deploy Pipeline
# Manual deployment with environment selection
# Best Practice: CI runs automatically, Deploy runs manually
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Deploy Pipeline

# Only run on manual trigger - NOT on every push
# This follows best practices: CI for validation, Deploy for controlled releases
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
      run_migrations:
        description: 'Run database migrations'
        type: boolean
        default: true

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Pre-deployment Validation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Version
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Deploying version: $VERSION"

      - name: Verify CI Passed
        run: |
          echo "âœ… Deployment initiated by: ${{ github.actor }}"
          echo "ğŸ¯ Target environment: ${{ github.event.inputs.environment }}"
          echo "ğŸ—„ï¸ Run migrations: ${{ github.event.inputs.run_migrations }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Deploy to Production
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == 'production'

    environment:
      name: production
      url: https://fluffnwoof.onrender.com

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Create Deployment Record
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ PRODUCTION DEPLOYMENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Deploy Backend
        run: |
          echo "ğŸ”„ Triggering backend deployment..."
          curl -X POST "${{ secrets.RENDER_PROD_BACKEND_HOOK }}" \
            -H "Content-Type: application/json"
          echo "âœ… Backend deployment triggered"

      - name: Wait for Backend
        run: |
          echo "â³ Waiting for backend to deploy (90 seconds)..."
          sleep 90

      - name: Run Database Migrations
        if: github.event.inputs.run_migrations == 'true'
        run: |
          echo "ğŸ—„ï¸ Running database migrations..."
          cd backend
          npm ci
          npx prisma migrate deploy
          echo "âœ… Migrations completed"
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}

      - name: Health Check Backend
        run: |
          echo "ğŸ¥ Checking backend health..."
          for i in {1..15}; do
            if curl -sf "https://fluffnwoof.onrender.com/health"; then
              echo ""
              echo "âœ… Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($i/15)"
            sleep 10
          done

      - name: Deploy Frontend
        run: |
          echo "ğŸ”„ Triggering frontend deployment..."
          curl -X POST "${{ secrets.RENDER_PROD_FRONTEND_HOOK }}" \
            -H "Content-Type: application/json"
          echo "âœ… Frontend deployment triggered"

      - name: Wait for Frontend
        run: |
          echo "â³ Waiting for frontend to deploy (60 seconds)..."
          sleep 60

      - name: Final Verification
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ DEPLOYMENT COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Backend: https://fluffnwoof.onrender.com"
          echo "Frontend: https://fluffnwoof-frontend.onrender.com"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Notify Slack (Success)
        if: success() && env.SLACK_WEBHOOK != ''
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-type: application/json' \
            -d '{"text":"ğŸš€ PRODUCTION deployed: ${{ needs.validate.outputs.version }} by ${{ github.actor }}"}' || true

      - name: Notify Slack (Failure)
        if: failure() && env.SLACK_WEBHOOK != ''
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-type: application/json' \
            -d '{"text":"ğŸš¨ PRODUCTION deployment FAILED: ${{ needs.validate.outputs.version }}"}' || true
